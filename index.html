<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ ¼ç©ç¶­åº¦ï½œé›²ç«¯ç®¡ç†ç³»çµ± Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
/* æ ¸å¿ƒé…è‰² - ä¿æŒåŸå§‹éœ“è™¹ç‰ˆä¸å¯è®Šå‹• */
:root { --primary: #0d1117; --accent: #00d2ff; --success: #39ff14; --danger: #ff3131; --warning: #ffcc00; --bg: #0d1117; --card-bg: rgba(22, 27, 34, 0.9); }

body { 
    font-family: "Microsoft JhengHei", sans-serif; 
    margin: 0; padding: 1rem; 
    background: var(--bg); color: #e6edf3; 
    background-image: radial-gradient(circle at 50% 50%, #161b22 0%, #0d1117 100%); 
    min-height: 100vh; 
}

h1, h2 { text-align: center; text-shadow: 0 0 10px var(--accent); color: var(--accent); }

/* æ€¥ä¿ƒå‘¼å¸ç‡ˆå‹•ç•« */
@keyframes urgent-breath {
    0% { box-shadow: 0 0 5px var(--danger); border-color: var(--danger); }
    50% { box-shadow: 0 0 20px var(--danger); border-color: #ff8888; }
    100% { box-shadow: 0 0 5px var(--danger); border-color: var(--danger); }
}

#imageOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    display: none; justify-content: center; align-items: center;
    z-index: 10000; cursor: zoom-out;
}
#imageOverlay img {
    max-width: 90%; max-height: 90%;
    border: 2px solid var(--accent); border-radius: 8px;
    box-shadow: 0 0 30px rgba(0,210,255,0.5);
}

.img-preview { 
    width: 50px; height: 50px; 
    object-fit: cover; border-radius: 4px; 
    border: 1px solid var(--accent); cursor: pointer;
    transition: 0.2s;
}
.img-preview:hover { transform: scale(1.1); filter: brightness(1.2); }

.img-upload-placeholder {
    width: 50px; height: 50px;
    border: 1px dashed #555; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; color: #888; cursor: pointer;
}

input[type="file"] { display: none; }

@keyframes mega-shake {
    0% { transform: translate(0,0) rotate(0deg); }
    10% { transform: translate(-8px, -8px) rotate(-2deg); }
    20% { transform: translate(8px, 8px) rotate(2deg); }
    100% { transform: translate(0,0) rotate(0); }
}
@keyframes zoom-in-out {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; filter: drop-shadow(0 0 20px red); }
    100% { transform: scale(2); opacity: 0; }
}

.shake-heavy { animation: mega-shake 0.3s both; border-color: var(--danger) !important; }

#backBtn { 
    position: fixed; top: 15px; left: 15px; 
    width: 50px; height: 50px; border-radius: 50%; 
    background: rgba(22, 27, 34, 0.85); color: var(--accent); 
    display: none; z-index: 999; border: 2px solid var(--accent);
    font-size: 24px; cursor: pointer; align-items: center; justify-content: center;
}

.logout-btn { 
    position: fixed; top: 15px; right: 15px; 
    background: var(--danger); padding: 10px 18px; border-radius: 10px;
    font-weight: bold; color: #fff; border: none; z-index: 998; cursor: pointer;
    display: none; 
}

#loginOverlay { position: fixed; inset: 0; background: #0d1117; display: flex; justify-content: center; align-items: center; z-index: 9999; }
.login-box { background: #161b22; padding: 2rem; border-radius: 20px; text-align: center; width: 300px; border: 2px solid var(--accent); position: relative; }
.pw-screen { 
    background: #000; font-size: 1.2rem; padding: 15px; border-radius: 12px; 
    margin-bottom: 20px; color: var(--accent); min-height: 45px; 
    letter-spacing: 5px; border: 1px solid var(--accent); 
    display: flex; justify-content: center; align-items: center;
    overflow: hidden; white-space: nowrap;
}

.lock-overlay { 
    position: absolute; inset: 0; background: rgba(20, 0, 0, 0.95); 
    display: none; flex-direction: column; justify-content: center; align-items: center; 
    z-index: 100; border-radius: 20px; border: 3px solid var(--danger);
}
.count-num { font-size: 6rem; font-weight: 900; color: white; animation: zoom-in-out 1s infinite; }

.numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.num-btn { background: #1c2128; border: 1px solid #30363d; padding: 18px; font-size: 1.4rem; border-radius: 15px; color: #fff; cursor: pointer; }

.search-container { max-width: 500px; margin: 0 auto 20px auto; padding: 0 10px; }
.search-input { 
    background: rgba(255,255,255,0.05); border: 1px solid var(--accent); border-radius: 20px; 
    padding: 10px 20px; color: white; width: 100%; box-sizing: border-box; text-align: center; outline: none;
}
.grid { display: grid; gap: 12px; width: 100%; max-width: 1200px; margin: 1.5rem auto; grid-template-columns: repeat(5, 1fr); }
.cell { background: var(--card-bg); border-radius: 12px; padding: 1rem 0.5rem; text-align: center; cursor: pointer; display: flex; flex-direction: column; justify-content: center; min-height: 85px; border: 1px solid #30363d; position: relative; }
.cell.empty { border: 1px dashed var(--accent); color: var(--accent); }
.cell.occupied { border: 1px solid var(--success); color: var(--success); }

.detail { max-width: 700px; margin: 20px auto 100px auto; background: var(--card-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #30363d; }
.row { display: grid; gap: 8px; margin-bottom: 1rem; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; position: relative; align-items: center; }
input, select { padding: 0.7rem; border-radius: 8px; background: #1c2128; border: 1px solid #30363d; color: #ffffff; width: 100%; box-sizing: border-box; }
button.action { padding: 0.8rem 1.2rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff; }
.primary { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
.success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
.danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
.warning { background: linear-gradient(45deg, #f39c12, #e67e22); color: #fff; }

.remove-btn { background: #441111; color: #ff5555; border: 1px solid #ff3131; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.sold-btn { background: #1a4a1a; color: #39ff14; border: 1px solid #39ff14; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }

#syncStatus { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; color: #555; }
</style>
</head>

<body onkeydown="handleGlobalKey(event)">

<div id="loginOverlay">
    <div class="login-box" id="loginBox">
        <div id="lockOverlay" class="lock-overlay">
            <div style="color:var(--danger); font-weight:900; letter-spacing:2px; margin-bottom:10px;">ç³»çµ±å®‰å…¨æ€§é–å®š</div>
            <div id="countDisplay" class="count-num"></div>
            <div style="color:white; font-size:0.8rem; margin-top:10px;">è«‹ç¨å¾Œå†è©¦</div>
        </div>
        <h2>æ ¼ç©ç¶­åº¦ç³»çµ±</h2>
        <div id="pwDisplay" class="pw-screen"></div>
        <div class="numpad">
            <button class="num-btn" onclick="press('1')">1</button>
            <button class="num-btn" onclick="press('2')">2</button>
            <button class="num-btn" onclick="press('3')">3</button>
            <button class="num-btn" onclick="press('4')">4</button>
            <button class="num-btn" onclick="press('5')">5</button>
            <button class="num-btn" onclick="press('6')">6</button>
            <button class="num-btn" onclick="press('7')">7</button>
            <button class="num-btn" onclick="press('8')">8</button>
            <button class="num-btn" onclick="press('9')">9</button>
            <button class="num-btn" style="color:var(--danger)" onclick="resetPw()">C</button>
            <button class="num-btn" onclick="press('0')">0</button>
            <button class="num-btn" style="color:var(--success)" onclick="loginCheck()">OK</button>
        </div>
    </div>
</div>

<button id="backBtn" onclick="goBack()">â†</button>
<button id="mainLogoutBtn" class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>

<div id="mainUI" style="display:none">
    <h1 id="pageTitle">å·¥ä½œç®¡ç†å€</h1>
    <div class="search-container" id="searchBarUI">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹æ ¼ä¸»å§“åæˆ–é›»è©±..." oninput="handleSearch()">
    </div>
    <div style="text-align: center; margin-bottom: 20px; display:none;" id="excelBtnContainer">
        <button class="action primary" onclick="exportExcel()">ğŸ“Š ä¸‹è¼‰ ABCD åˆ†å€ç¸½å ±è¡¨</button>
    </div>
    <div id="gridPage" class="grid"></div>
    <div id="detailPage" class="detail" style="display:none">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 id="dCode" style="margin: 0;"></h2>
            <button id="singleExportBtn" class="action warning" style="padding: 5px 12px; font-size: 0.8rem;" onclick="exportSingleExcel()">ğŸ“Š ä¸‹è¼‰æ­¤æ ¼ä¸» Excel</button>
        </div>
        
        <div id="productSection">
            <div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">ğŸ“¦ å•†å“ç®¡ç†</div>
            <div id="products"></div>
        </div>

        <button id="addProdBtn" class="action primary" style="margin-bottom:2rem; width:100%" onclick="addProduct()">ï¼‹ æ–°å¢å•†å“é …ç›®</button>
        
        <div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">ğŸ‘¤ æ ¼ä¸»è³‡è¨Š</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:1.5rem;">
            <div><label>ğŸ”å§“å</label><input id="dOwner"></div>
            <div><label>ğŸ“²é›»è©±</label><input id="dContact"></div>
            <div><label>ğŸ’´æœˆç§Ÿ</label><input type="number" id="dRent"></div>
            <div><label>ğŸ’°æŠ¼é‡‘</label><input type="number" id="dDeposit"></div>
            <div><label>ğŸ“…ç°½ç´„</label><input id="dSignDate" onblur="autoFormatDate(this)"></div>
            <div><label>ğŸ“†åˆ°æœŸ</label><input id="dPeriod" onblur="autoFormatDate(this)"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="action success" style="flex:2" id="saveBtn" onclick="saveDetail()">ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´</button>
            <button class="action danger" style="flex:1;" id="delBtn" onclick="deleteThisCell()">âŒ æ¸…ç©º</button>
        </div>
    </div>
</div>

<div id="imageOverlay" onclick="this.style.display='none'">
    <img id="fullImage" src="">
</div>

<div id="syncStatus">é›²ç«¯ç‹€æ…‹ï¼šå°±ç·’</div>

<script>
const CLOUD_URL ="https://script.google.com/macros/s/AKfycbwvVtgF0pjJukXPRUqsbVOPg_aOErftTK0FIajy3-6VchyEuXgHoC3NozJgGoItKNbW/exec; 

let data = [];
let currentZone = null, currentItem = null, tempPw = "", loginType = "";
let errorCounter = 0, isLocked = false, autoSyncTimer = null;

window.onload = async () => {
    checkPersistentLock();
    const savedSession = localStorage.getItem("gw_login_session");
    if (savedSession) {
        document.getElementById('loginOverlay').style.display = "none";
        document.getElementById('syncStatus').innerText = "è‡ªå‹•ç™»å…¥ä¸­...";
        await loadFromCloud();
        startApp(savedSession);
    }
};

function checkPersistentLock() {
    const lockUntil = localStorage.getItem("gw_locked_until");
    if (lockUntil) {
        const remaining = Math.ceil((parseInt(lockUntil) - Date.now()) / 1000);
        if (remaining > 0) triggerLockdown(remaining);
        else localStorage.removeItem("gw_locked_until");
    }
}

async function loadFromCloud() {
    // ç·¨è¼¯ä¸­ä¸è‡ªå‹•åˆ·æ–°ï¼Œé¿å…è¼¸å…¥å…§å®¹æ¶ˆå¤±
    if (document.getElementById('detailPage').style.display === "block") return;
    
    document.getElementById('syncStatus').innerText = "é›²ç«¯åŒæ­¥ä¸­...";
    try {
        const response = await fetch(CLOUD_URL);
        const newData = await response.json();
        if (newData && newData.length > 0) {
            data = newData;
            localStorage.setItem("gw_data", JSON.stringify(data));
            if (currentZone) openZone(currentZone); else showZones();
        }
        document.getElementById('syncStatus').innerText = "é›²ç«¯ç‹€æ…‹ï¼šå·²åŒæ­¥ " + new Date().toLocaleTimeString();
        document.getElementById('syncStatus').style.color = "#555";
    } catch (e) {
        data = JSON.parse(localStorage.getItem("gw_data")) || [];
        document.getElementById('syncStatus').innerText = "é›²ç«¯ç‹€æ…‹ï¼šé›¢ç·šæ¨¡å¼";
    }
}

async function saveToCloud() {
    const btn = document.getElementById('saveBtn');
    if(btn) { btn.innerText = "åŒæ­¥ä¸­..."; btn.disabled = true; }
    try {
        localStorage.setItem("gw_data", JSON.stringify(data));
        await fetch(CLOUD_URL, { method: "POST", body: JSON.stringify(data), mode: 'no-cors' });
        document.getElementById('syncStatus').innerText = "é›²ç«¯ç‹€æ…‹ï¼šåŒæ­¥æˆåŠŸ " + new Date().toLocaleTimeString();
        document.getElementById('syncStatus').style.color = "var(--success)";
    } catch (e) { 
        console.error("åŒæ­¥å¤±æ•—"); 
        document.getElementById('syncStatus').innerText = "é›²ç«¯ç‹€æ…‹ï¼šåŒæ­¥å¤±æ•—";
        document.getElementById('syncStatus').style.color = "var(--danger)";
    }
    if(btn) { btn.innerText = "ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´"; btn.disabled = false; }
}

function press(n) { if(!isLocked && tempPw.length < 4) { tempPw += n; updateDisplay(); } }
function resetPw() { tempPw = ""; updateDisplay(); }
function updateDisplay() { document.getElementById('pwDisplay').innerText = "â€¢".repeat(tempPw.length); }

async function loginCheck() { 
    if(isLocked) return;
    const screen = document.getElementById('pwDisplay');
    
    // æŒ‡ä»¤è¦ç¯„ï¼š9527 ä¸€èˆ¬æ¨¡å¼ï¼Œ1688èˆ‡9527çš†å¯ç‚ºç®¡ç†è€…
    const isAdmin = (tempPw === "1688" || tempPw === "9527");
    const isOwner = (tempPw === "9527");

    if (isAdmin || isOwner) {
        let type = (tempPw === "1688") ? "boss" : (tempPw === "9527" ? "boss" : "owner"); 
        // æ³¨æ„ï¼šè‹¥ 9527 é è¨­é€²ç®¡ç†è€…è«‹è¨­ç‚º bossï¼Œè‹¥ 9527 æ˜¯çœ‹æ¬Šé™è«‹è‡ªè¡Œåˆ‡æ›
        
        screen.style.letterSpacing = "1px";
        screen.innerText = "è®€å–ä¸­...";
        
        await loadFromCloud();
        
        screen.innerText = "è®€å–å®Œæˆï¼Œæ­¡è¿"; 
        localStorage.setItem("gw_login_session", type); 
        
        setTimeout(() => {
            startApp(type);
            resetPw();
            screen.style.letterSpacing = "5px"; 
        }, 800);
    } else { 
        errorCounter++;
        screen.style.letterSpacing = "1px"; screen.style.color = "var(--danger)"; screen.innerText = "è¼¸å…¥éŒ¯èª¤";
        document.getElementById('loginBox').classList.add('shake-heavy');
        setTimeout(() => { 
            document.getElementById('loginBox').classList.remove('shake-heavy'); 
            screen.style.color = "var(--accent)"; screen.style.letterSpacing = "5px"; resetPw(); 
        }, 800);
        if (errorCounter >= 3) {
            const lockTime = 30;
            localStorage.setItem("gw_locked_until", Date.now() + (lockTime * 1000));
            triggerLockdown(lockTime);
        }
    } 
}

function triggerLockdown(seconds) {
    isLocked = true; errorCounter = 0;
    const overlay = document.getElementById('lockOverlay');
    overlay.style.display = 'flex';
    let timeLeft = seconds;
    const timer = setInterval(() => {
        document.getElementById('countDisplay').innerText = timeLeft;
        if (timeLeft <= 0) { 
            clearInterval(timer); overlay.style.display = 'none'; isLocked = false; 
            localStorage.removeItem("gw_locked_until"); resetPw(); 
        }
        timeLeft--;
    }, 1000);
}

function startApp(type) { 
    loginType = type; 
    document.getElementById('loginOverlay').style.display = "none"; 
    document.getElementById('mainUI').style.display = "block"; 
    document.getElementById('mainLogoutBtn').style.display = "block";
    document.getElementById('pageTitle').innerText = (type==="boss"?"ç¸½ç›£æ¨¡å¼":"æ ¼ä¸»æ¨¡å¼");
    if(type === "boss") document.getElementById('excelBtnContainer').style.display = "block";
    showZones(); 
    if(autoSyncTimer) clearInterval(autoSyncTimer);
    autoSyncTimer = setInterval(loadFromCloud, 30000);
}

function renderProducts() {
    const productsDiv = document.getElementById('products');
    const section = document.getElementById('productSection');
    
    if (!currentItem.products || currentItem.products.length === 0) {
        section.style.display = "none";
        productsDiv.innerHTML = "";
    } else {
        section.style.display = "block";
        productsDiv.innerHTML = "";
        currentItem.products.forEach((p, i) => {
            const r = document.createElement("div");
            const isSold = (p.type === "å·²å”®å‡º");
            const isOwner = (loginType === "owner"); 
            const isAdmin = (loginType === "boss"); 
            const forceLocked = (isOwner && p.isSaved);
            r.className = "row";
            if(isSold) { r.style.border = "1px solid var(--danger)"; r.style.boxShadow = "inset 0 0 10px rgba(255, 49, 49, 0.2)"; }
            
            let imgHTML = p.img 
                ? `<div style="position:relative"><img src="${p.img}" class="img-preview" onclick="viewImage('${p.img}')">${!forceLocked ? `<div onclick="triggerUpload(${i})" style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.6); font-size:10px; padding:2px; cursor:pointer;">ğŸ”„</div>` : ''}</div>`
                : `<div class="img-upload-placeholder" ${forceLocked ? "" : `onclick="triggerUpload(${i})"`}>ğŸ“·</div>`;
            
            let fileInput = `<input type="file" id="file-${i}" accept="image/*" onchange="handleImgUpload(this, ${i})">`;
            let inner = `${imgHTML} ${fileInput}
                         <div style="display:flex; flex-direction:column; gap:2px; width:100%;">
                            ${isSold ? '<span style="color:var(--danger); font-size:0.7rem; font-weight:bold; margin-bottom:2px;">ğŸš© å·²å”®å‡º</span>' : ''}
                            <input value="${p.name||''}" oninput="currentItem.products[${i}].name=this.value" placeholder="å“å" ${forceLocked?"readonly":""}>
                         </div>
                         <select onchange="handleTypeChange(this.value, ${i})" ${forceLocked?"disabled":""}>
                            <option value="ç›´å”®" ${p.type==='ç›´å”®' || isSold ?'selected':''}>ç›´å”®</option>
                            <option value="åˆ®å¡" ${p.type==='åˆ®å¡'?'selected':''}>åˆ®å¡</option>
                            <option value="å±•ç¤º" ${p.type==='å±•ç¤º'?'selected':''}>å±•ç¤º</option>
                         </select>`;
            
            const showActionArea = isAdmin || (!forceLocked);
            if (p.type === "åˆ®å¡") {
                r.style.gridTemplateColumns = showActionArea ? "60px 1.5fr 1fr 1fr 1fr 80px" : "60px 1.5fr 1fr 1fr 1fr";
                inner += `<input type="number" placeholder="æ ¼" value="${p.total||''}" oninput="currentItem.products[${i}].total=this.value" ${forceLocked?"readonly":""}>
                          <input type="number" placeholder="åƒ¹" value="${p.price||''}" oninput="currentItem.products[${i}].price=this.value" ${forceLocked?"readonly":""}>`;
            } else {
                r.style.gridTemplateColumns = showActionArea ? "60px 1.5fr 1fr 2fr 80px" : "60px 1.5fr 1fr 2fr";
                inner += `<input type="number" placeholder="åƒ¹" value="${p.price||''}" oninput="currentItem.products[${i}].price=this.value" ${forceLocked?"readonly":""}>`;
            }
            if (showActionArea) {
                inner += `<div style="display:flex; gap:5px; justify-content:center;">`;
                if (isAdmin) inner += `<button class="sold-btn" onclick="toggleSold(${i})">${isSold ? "ğŸ”™" : "ğŸ’°"}</button>`;
                inner += `<button class="remove-btn" onclick="removeProduct(${i})">âœ•</button>`;
                inner += `</div>`;
            }
            r.innerHTML = inner; productsDiv.appendChild(r);
        });
    }
}

function addProduct() { 
    if (!currentItem.products) currentItem.products = [];
    currentItem.products.push({ name: "", type: "ç›´å”®", price: "", total: "", isSaved: false, img: "" }); 
    renderProducts(); 
}

async function saveDetail() {
    if (loginType === "boss") {
        currentItem.owner = document.getElementById('dOwner').value;
        currentItem.contact = document.getElementById('dContact').value;
        currentItem.rent = document.getElementById('dRent').value;
        currentItem.deposit = document.getElementById('dDeposit').value;
        currentItem.period = document.getElementById('dPeriod').value;
        currentItem.signDate = document.getElementById('dSignDate').value;
    }
    
    if (currentItem.products) {
        currentItem.products.forEach(p => { if (p.name || p.img) p.isSaved = true; });
    }

    if (loginType === "owner") {
        if (confirm("å„²å­˜å¾Œç¾æœ‰å•†å“å°‡é–å®šä¸”ä¸å¯åˆªé™¤ï¼Œç¢ºå®šå„²å­˜ï¼Ÿ")) { await saveToCloud(); goBack(); }
    } else {
        await saveToCloud(); goBack();
    }
}

async function deleteThisCell() {
    if (loginType !== "boss") return;
    if (confirm(`ç¢ºå®šè¦æ¸…ç©º ${getCode(currentItem)} çš„æ ¼ä¸»è³‡æ–™å—ï¼Ÿ`)) {
        currentItem.owner = ""; currentItem.contact = ""; currentItem.rent = "";
        currentItem.deposit = ""; currentItem.period = ""; currentItem.signDate = "";
        currentItem.products = [];
        await saveToCloud();
        goBack();
    }
}

function openDetail(item, code) {
    currentItem = item; document.getElementById('dCode').textContent = "ä½ç½®ï¼š" + code;
    document.getElementById('dOwner').value = item.owner || ""; 
    document.getElementById('dContact').value = item.contact || ""; 
    document.getElementById('dRent').value = item.rent || ""; 
    document.getElementById('dDeposit').value = item.deposit || ""; 
    document.getElementById('dPeriod').value = item.period || ""; 
    document.getElementById('dSignDate').value = item.signDate || "";
    
    let canEditInfo = (loginType === "boss");
    const fields = ['dOwner', 'dContact', 'dRent', 'dDeposit', 'dPeriod', 'dSignDate'];
    fields.forEach(f => document.getElementById(f).readOnly = !canEditInfo);
    
    document.getElementById('delBtn').style.display = (loginType === "boss") ? "block" : "none";
    renderProducts(); 
    document.getElementById('gridPage').style.display = "none"; 
    document.getElementById('detailPage').style.display = "block";
    document.getElementById('searchBarUI').style.display = "none";
    document.getElementById('backBtn').style.display = "flex";
}

function showZones() {
    currentZone = null; const grid = document.getElementById('gridPage'); grid.innerHTML = ""; 
    document.getElementById('detailPage').style.display = "none"; grid.style.display = "grid"; 
    document.getElementById('backBtn').style.display = "none";
    document.getElementById('searchBarUI').style.display = "block";
    ["A", "B", "C", "D"].forEach(z => {
        const div = document.createElement("div"); div.className = `cell empty`;
        div.innerHTML = `<div>${z} å€</div><small>ç§Ÿ: ${data.filter(d => d.zone === z && d.owner).length}</small>`;
        div.onclick = () => openZone(z); grid.appendChild(div);
    });
}

function openZone(z) {
    currentZone = z; const grid = document.getElementById('gridPage'); grid.innerHTML = ""; 
    document.getElementById('backBtn').style.display = "flex";
    document.getElementById('searchBarUI').style.display = "block";
    const today = new Date();
    data.filter(d => d.zone === z).forEach(item => {
        const c = document.createElement("div"); const code = getCode(item);
        let statusClass = item.owner ? 'occupied' : 'empty';
        c.className = `cell ${statusClass}`;
        let extraStyle = "";
        if(item.period) {
            const expDate = new Date(item.period);
            const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            if(diffDays <= 2) extraStyle = "color:var(--danger); border-color:var(--danger); animation: urgent-breath 0.6s infinite;";
            else if(diffDays <= 7) extraStyle = "color:var(--warning); border-color:var(--warning);";
        }
        c.style = extraStyle;
        c.innerHTML = `<div>${code}</div><div style="font-weight:bold;">${item.owner || ''}</div>${item.period?`<div style="font-size:0.7rem; margin-top:4px;">${item.period}</div>`:""}`;
        c.onclick = () => openDetail(item, code); grid.appendChild(c);
    });
}

function getCode(item) {
    if (item.zone === "A" || item.zone === "B") {
        const r = Math.floor((item.number - 1) / 5) + 1, col = ((item.number - 1) % 5) + 1;
        return `${item.zone}${String(r).padStart(2, "0")}-${String(col).padStart(2, "0")}`;
    }
    return `${item.zone}${String(item.number).padStart(2, "0")}`;
}

function logout() { if(confirm("ç¢ºå®šç™»å‡ºç³»çµ±ï¼Ÿ")) { localStorage.removeItem("gw_login_session"); location.reload(); } }

function goBack() { 
    if (document.getElementById('detailPage').style.display === "block") { 
        document.getElementById('detailPage').style.display = "none"; 
        document.getElementById('gridPage').style.display = "grid"; 
        document.getElementById('searchBarUI').style.display = "block";
        if(currentZone) openZone(currentZone); else showZones(); 
    } 
    else if (currentZone) showZones(); 
}

function handleGlobalKey(e) {
    const isInput = (e.target.tagName === "INPUT" || e.target.tagName === "SELECT" || e.target.tagName === "TEXTAREA");
    if (document.getElementById('loginOverlay').style.display !== "none") {
        if (/[0-9]/.test(e.key)) press(e.key);
        if (e.key === "Enter") loginCheck();
        if (e.key === "Backspace") { e.preventDefault(); resetPw(); }
        return;
    }
    if (!isInput) {
        if (e.key === "Backspace") { e.preventDefault(); goBack(); }
        if (e.key === "Enter") { if (document.getElementById('detailPage').style.display === "block") saveDetail(); }
    }
}

function autoFormatDate(input) {
    let val = input.value.replace(/\D/g, '');
    if (val.length === 8) { input.value = val.substring(0, 4) + "/" + val.substring(4, 6) + "/" + val.substring(6, 8); } 
}

async function toggleSold(i) {
    const p = currentItem.products[i];
    if (p.type === "å·²å”®å‡º") p.type = "ç›´å”®";
    else { if(confirm("ç¢ºå®šæ¨™è¨˜ç‚ºå·²å”®å‡ºï¼Ÿ")) p.type = "å·²å”®å‡º"; else return; }
    renderProducts(); await saveToCloud();
}

function handleTypeChange(v, i) { 
    currentItem.products[i].type = v; 
    if (v === "å±•ç¤º") currentItem.products[i].price = "å±•ç¤ºä¸­"; 
    renderProducts(); 
}

async function removeProduct(i) { 
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤å•†å“é …ç›®ï¼Ÿ")) { 
        currentItem.products.splice(i, 1); 
        renderProducts(); 
        await saveToCloud();
    } 
}

function triggerUpload(i) { document.getElementById(`file-${i}`).click(); }

function handleImgUpload(input, i) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; let w = img.width, h = img.height;
                if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                canvas.width = w; canvas.height = h;
                canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                currentItem.products[i].img = canvas.toDataURL("image/jpeg", 0.7);
                renderProducts();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function viewImage(src) { document.getElementById('fullImage').src = src; document.getElementById('imageOverlay').style.display = 'flex'; }

function handleSearch() {
    const term = document.getElementById('searchInput').value.trim().toLowerCase();
    const grid = document.getElementById('gridPage');
    if (term === "") { if (currentZone) openZone(currentZone); else showZones(); return; }
    
    grid.innerHTML = "";
    document.getElementById('backBtn').style.display = "flex";
    const results = data.filter(d => (d.owner && d.owner.toLowerCase().includes(term)) || (d.contact && d.contact.includes(term)));
    
    results.forEach(item => {
        const c = document.createElement("div");
        const code = getCode(item);
        c.className = `cell occupied`;
        c.innerHTML = `<div>${code}</div><div style="font-weight:bold;">${item.owner}</div><div style="font-size:0.7rem;">${item.zone}å€</div>`;
        c.onclick = () => openDetail(item, code);
        grid.appendChild(c);
    });
}

function exportExcel() {
    const wb = XLSX.utils.book_new();
    ["A", "B", "C", "D"].forEach(z => {
        const zoneData = data.filter(d => d.zone === z).map(d => ({ 
            "ç·¨è™Ÿ": getCode(d), 
            "æ ¼ä¸»": d.owner, 
            "é›»è©±": d.contact, 
            "æœˆç§Ÿ": d.rent, 
            "æŠ¼é‡‘": d.deposit, 
            "åˆ°æœŸæ—¥": d.period, 
            "å•†å“": d.products ? d.products.map(p=>`[${p.type}]${p.name}`).join(",") : "" 
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(zoneData), z + "å€");
    });
    XLSX.writeFile(wb, "æ ¼ç©ç¶­åº¦ç¸½å ±è¡¨.xlsx");
}

function exportSingleExcel() {
    const wb = XLSX.utils.book_new();
    const code = getCode(currentItem);
    const info = [
        ["ä½ç½®", code], ["å§“å", currentItem.owner], ["é›»è©±", currentItem.contact], 
        ["ç§Ÿé‡‘", currentItem.rent], ["æŠ¼é‡‘", currentItem.deposit], ["ç°½ç´„", currentItem.signDate], 
        ["åˆ°æœŸ", currentItem.period], ["", ""], 
        ["å“å", "é¡å‹", "å–®åƒ¹", "è©³æƒ…"]
    ];
    if (currentItem.products) {
        currentItem.products.forEach(p => info.push([p.name, p.type, p.price, p.type==="åˆ®å¡"?p.total:"" ]));
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(info), "å ±è¡¨");
    XLSX.writeFile(wb, `å ±è¡¨_${code}.xlsx`);
}
</script>
</body>
</html>
