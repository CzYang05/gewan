<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ ¼ç©ç¶­åº¦ï½œç®¡ç†ç³»çµ± Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
/* æ ¸å¿ƒé…è‰² */
:root { --primary: #0d1117; --accent: #00d2ff; --success: #39ff14; --danger: #ff3131; --warning: #ffcc00; --bg: #0d1117; --card-bg: rgba(22, 27, 34, 0.9); }

body { 
    font-family: "Microsoft JhengHei", sans-serif; 
    margin: 0; padding: 1rem; 
    background: var(--bg); color: #e6edf3; 
    background-image: radial-gradient(circle at 50% 50%, #161b22 0%, #0d1117 100%); 
    min-height: 100vh; 
}

h1, h2 { text-align: center; text-shadow: 0 0 10px var(--accent); color: var(--accent); }

/* --- å‹•ç•«æ•ˆæœ --- */
@keyframes mega-shake {
    0% { transform: translate(0,0); }
    10% { transform: translate(-8px, -8px); }
    20% { transform: translate(8px, 8px); }
    50% { transform: translate(-8px, 8px); }
    80% { transform: translate(8px, -8px); }
    100% { transform: translate(0,0); }
}
@keyframes flash-red { 0%, 100% { background: #0d1117; } 50% { background: #660000; } }
.shake-heavy { animation: mega-shake 0.3s infinite; }
.flash-screen { animation: flash-red 0.2s infinite; }

/* --- UI å…ƒç´  --- */
#backBtn { 
    position: fixed; top: 15px; left: 15px; 
    width: 50px; height: 50px; border-radius: 50%; 
    background: rgba(22, 27, 34, 0.85); color: var(--accent); 
    display: none; z-index: 999; border: 2px solid var(--accent);
    font-size: 24px; cursor: pointer; align-items: center; justify-content: center;
}

.logout-btn { 
    position: fixed; top: 15px; right: 15px; 
    background: var(--danger); padding: 10px 18px; border-radius: 10px;
    font-weight: bold; color: #fff; border: none; z-index: 998; cursor: pointer; display: none; 
}

#loginOverlay { position: fixed; inset: 0; background: #0d1117; display: flex; justify-content: center; align-items: center; z-index: 9999; }
.login-box { background: #161b22; padding: 2rem; border-radius: 20px; text-align: center; width: 300px; border: 2px solid var(--accent); position: relative; }
.pw-screen { background: #000; font-size: 2.2rem; padding: 15px; border-radius: 12px; margin-bottom: 20px; color: var(--accent); min-height: 45px; letter-spacing: 5px; border: 1px solid var(--accent); display: flex; justify-content: center; align-items: center; }

/* é–å®šè“‹æ¿ */
.lock-overlay { position: absolute; inset: 0; background: rgba(20, 0, 0, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; border-radius: 20px; border: 3px solid var(--danger); }

/* æ ¼ä½é¡¯ç¤ºå„ªåŒ– */
.grid { display: grid; gap: 10px; width: 100%; max-width: 1200px; margin: 1.5rem auto; grid-template-columns: repeat(4, 1fr); }
.cell { background: var(--card-bg); border-radius: 10px; padding: 12px 5px; text-align: center; cursor: pointer; border: 1px solid #30363d; display: flex; flex-direction: column; justify-content: center; min-height: 90px; line-height: 1.2; }
.cell b { font-size: 1.1rem; color: var(--accent); display: block; margin-bottom: 4px; }
.cell span { font-size: 0.85rem; }
.cell.occupied { border: 1px solid var(--success); color: var(--success); }

/* å•†å“é¸å–®ä¿®æ­£ */
.row { display: grid; gap: 8px; margin-bottom: 1rem; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; }
select { padding: 0.7rem 0.3rem; border-radius: 8px; background: #1c2128; border: 1px solid var(--accent); color: #fff; min-width: 85px; font-size: 0.9rem; }

/* QR Code å½ˆçª— */
#qrModal { 
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 15px; z-index: 10001; 
    display: none; flex-direction: column; align-items: center; border: 5px solid var(--accent);
}
#modalBg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: none; }
</style>
</head>

<body onkeydown="handleGlobalKey(event)">

<div id="loginOverlay">
    <div class="login-box" id="loginBox">
        <div id="lockOverlay" class="lock-overlay">
            <h3 style="color:var(--danger)">ç³»çµ±é–å®š</h3>
            <div id="countDisplay" style="font-size:3rem; color:white"></div>
        </div>
        <h2>æ ¼ç©ç¶­åº¦ç³»çµ±</h2>
        <div id="pwDisplay" class="pw-screen"></div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('1')">1</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('2')">2</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('3')">3</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('4')">4</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('5')">5</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('6')">6</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('7')">7</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('8')">8</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('9')">9</button>
            <button class="num-btn" style="background:#441111; color:var(--danger); border-radius:10px;" onclick="resetPw()">C</button>
            <button class="num-btn" style="padding:15px; background:#1c2128; color:#fff; border-radius:10px;" onclick="press('0')">0</button>
            <button class="num-btn" style="background:#114411; color:var(--success); border-radius:10px;" onclick="loginCheck()">OK</button>
        </div>
    </div>
</div>

<button id="backBtn" onclick="goBack()">â†</button>
<button id="mainLogoutBtn" class="logout-btn" onclick="logout()">ç™»å‡º</button>

<div id="mainUI" style="display:none">
    <h1 id="pageTitle">å·¥ä½œç®¡ç†å€</h1>
    <div id="gridPage" class="grid"></div>
    
    <div id="detailPage" style="display:none; max-width:600px; margin: 0 auto; background:var(--card-bg); padding:1.5rem; border-radius:15px;">
        <h2 id="dCode"></h2>
        <button id="qrGenBtn" class="action primary" style="width:100%; margin-bottom:1rem; display:none;" onclick="showQr()">ğŸ“± ç”Ÿæˆæ­¤æ ¼ QR Code</button>
        
        <div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">ğŸ“¦ å•†å“é …ç›®</div>
        <div id="products"></div>
        <button class="action primary" style="width:100%; margin: 1rem 0;" onclick="addProduct()">ï¼‹ æ–°å¢å•†å“</button>

        <div style="font-weight:bold; margin-top:1rem; color:var(--accent);">ğŸ‘¤ æ ¼ä¸»è³‡è¨Š</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input id="dOwner" placeholder="æ ¼ä¸»å§“å">
            <input id="dContact" placeholder="è¯çµ¡é›»è©±">
            <input id="dRent" type="number" placeholder="æœˆç§Ÿé‡‘">
            <input id="dSignDate" placeholder="ç°½ç´„æ—¥ (YYYYMMDD)" onblur="autoFormatDate(this)">
            <input id="dPeriod" placeholder="åˆ°æœŸæ—¥ (YYYYMMDD)" onblur="autoFormatDate(this)" style="grid-column: span 2;">
        </div>
        <button class="action success" style="width:100%; margin-top:1.5rem; padding:15px;" onclick="saveDetail()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
    </div>
</div>

<div id="modalBg" onclick="closeQr()"></div>
<div id="qrModal">
    <div id="qrcode"></div>
    <p style="color:#000; margin-top:10px; font-weight:bold;" id="qrText"></p>
    <button class="action danger" onclick="closeQr()">é—œé–‰</button>
</div>

<script>
let data = JSON.parse(localStorage.getItem("gw_data")) || [];
let currentZone = null, currentItem = null, tempPw = "", loginType = "", errorCount = 0;

function press(n) { if(tempPw.length < 4) { tempPw += n; updateDisplay(); } }
function resetPw() { tempPw = ""; updateDisplay(); }
function updateDisplay() { document.getElementById('pwDisplay').innerText = "â€¢".repeat(tempPw.length); }

function loginCheck() {
    if(tempPw === "1688") startApp("boss");
    else if(tempPw === "6969") startApp("staff");
    else if(tempPw === "9527") startApp("owner");
    else {
        errorCount++;
        document.getElementById('loginBox').classList.add('shake-heavy');
        if(errorCount >= 3) {
            errorCount = 0; triggerLock();
        } else {
            setTimeout(() => { document.getElementById('loginBox').classList.remove('shake-heavy'); resetPw(); }, 500);
        }
    }
}

function triggerLock() {
    let sec = 5;
    const lock = document.getElementById('lockOverlay');
    lock.style.display = 'flex';
    document.getElementById('loginOverlay').classList.add('flash-screen');
    const timer = setInterval(() => {
        document.getElementById('countDisplay').innerText = sec;
        if(sec <= 0) {
            clearInterval(timer);
            lock.style.display = 'none';
            document.getElementById('loginOverlay').classList.remove('flash-screen');
            document.getElementById('loginBox').classList.remove('shake-heavy');
            resetPw();
        }
        sec--;
    }, 1000);
}

function startApp(type) {
    loginType = type;
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
    document.getElementById('mainLogoutBtn').style.display = 'block';
    document.getElementById('pageTitle').innerText = type==="boss"?"ç¸½ç›£":type==="staff"?"å“¡å·¥":"æ ¼ä¸»";
    initData(); showZones();
}

function initData() {
    const config = { "A": 60, "B": 20, "C": 20, "D": 20 };
    Object.keys(config).forEach(z => {
        if (data.filter(d => d.zone === z).length === 0) {
            for (let i = 1; i <= config[z]; i++) data.push({ zone: z, number: i, products: [], owner: "", contact: "", rent: "", period: "", signDate: "" });
        }
    });
}

function showZones() {
    currentZone = null; const grid = document.getElementById('gridPage');
    grid.innerHTML = ""; grid.style.display = "grid";
    document.getElementById('detailPage').style.display = "none";
    document.getElementById('backBtn').style.display = "none";
    ["A", "B", "C", "D"].forEach(z => {
        const d = document.createElement("div"); d.className = "cell";
        d.innerHTML = `<b>${z} å€</b><span>é»æ“Šé€²å…¥</span>`;
        d.onclick = () => openZone(z); grid.appendChild(d);
    });
}

function openZone(z) {
    currentZone = z; const grid = document.getElementById('gridPage');
    grid.innerHTML = ""; document.getElementById('backBtn').style.display = "flex";
    data.filter(d => d.zone === z).forEach(item => {
        const code = getCode(item);
        const d = document.createElement("div");
        d.className = item.owner ? "cell occupied" : "cell";
        // A, B å€æ›è¡Œé¡¯ç¤º
        if(z === "A" || z === "B") {
            const parts = code.split(/(?=[0-9])/); 
            d.innerHTML = `<b>${parts[0]}</b><span>${parts.slice(1).join("")}</span><small>${item.owner||'ç©º'}</small>`;
        } else {
            d.innerHTML = `<b>${code}</b><small>${item.owner||'ç©º'}</small>`;
        }
        d.onclick = () => openDetail(item, code); grid.appendChild(d);
    });
}

function getCode(item) {
    if (item.zone === "A" || item.zone === "B") {
        const r = Math.floor((item.number - 1) / 5) + 1, col = ((item.number - 1) % 5) + 1;
        return `${item.zone}${String(r).padStart(2, "0")}-${String(col).padStart(2, "0")}`;
    }
    return `${item.zone}${String(item.number).padStart(2, "0")}`;
}

function openDetail(item, code) {
    currentItem = item;
    document.getElementById('gridPage').style.display = "none";
    document.getElementById('detailPage').style.display = "block";
    document.getElementById('dCode').innerText = "ä½ç½®ï¼š" + code;
    document.getElementById('qrGenBtn').style.display = (loginType === "staff" || loginType === "boss") ? "block" : "none";
    
    document.getElementById('dOwner').value = item.owner;
    document.getElementById('dContact').value = item.contact;
    document.getElementById('dRent').value = item.rent;
    document.getElementById('dSignDate').value = item.signDate;
    document.getElementById('dPeriod').value = item.period;
    renderProducts();
}

function renderProducts() {
    const container = document.getElementById('products');
    container.innerHTML = "";
    currentItem.products.forEach((p, i) => {
        const r = document.createElement("div"); r.className = "row";
        r.style.gridTemplateColumns = "1.5fr 1fr 1fr 40px";
        r.innerHTML = `
            <input value="${p.name}" oninput="currentItem.products[${i}].name=this.value" placeholder="å“å">
            <select onchange="currentItem.products[${i}].type=this.value; renderProducts()">
                <option value="ç›´å”®" ${p.type==='ç›´å”®'?'selected':''}>ç›´å”®</option>
                <option value="åˆ®å¡" ${p.type==='åˆ®å¡'?'selected':''}>åˆ®å¡</option>
                <option value="å±•ç¤º" ${p.type==='å±•ç¤º'?'selected':''}>å±•ç¤º</option>
            </select>
            <input type="number" value="${p.price}" oninput="currentItem.products[${i}].price=this.value" placeholder="åƒ¹æ ¼">
            <button style="background:none; border:none; color:red; font-size:1.5rem;" onclick="currentItem.products.splice(${i},1); renderProducts()">âœ•</button>
        `;
        container.appendChild(r);
    });
}

function addProduct() { currentItem.products.push({name:"", type:"ç›´å”®", price:""}); renderProducts(); }

function saveDetail() {
    currentItem.owner = document.getElementById('dOwner').value;
    currentItem.contact = document.getElementById('dContact').value;
    currentItem.rent = document.getElementById('dRent').value;
    currentItem.signDate = document.getElementById('dSignDate').value;
    currentItem.period = document.getElementById('dPeriod').value;
    localStorage.setItem("gw_data", JSON.stringify(data));
    alert("å„²å­˜æˆåŠŸ"); goBack();
}

function goBack() { 
    if(document.getElementById('detailPage').style.display === "block") {
        document.getElementById('detailPage').style.display = "none";
        openZone(currentZone);
    } else { showZones(); }
}

function showQr() {
    const code = getCode(currentItem);
    document.getElementById('modalBg').style.display = "block";
    document.getElementById('qrModal').style.display = "flex";
    document.getElementById('qrcode').innerHTML = "";
    document.getElementById('qrText').innerText = "æ ¼ä½ï¼š" + code;
    new QRCode(document.getElementById("qrcode"), {
        text: window.location.href + "?cell=" + code,
        width: 200, height: 200
    });
}
function closeQr() { document.getElementById('modalBg').style.display = "none"; document.getElementById('qrModal').style.display = "none"; }
function autoFormatDate(i) { if(i.value.length===8) i.value = i.value.replace(/(\d{4})(\d{2})(\d{2})/, "$1/$2/$3"); }
function logout() { location.reload(); }
</script>

</body>
</html>
